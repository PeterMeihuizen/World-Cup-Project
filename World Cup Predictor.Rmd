---
title: "2023 Rugby World Predictor"
author: "Peter Meihuizen"
date: "2023-06-23"
output: html_document
---
Introduction:

For this project I will attempt to predict the winner of the 2023 Rugby World Cup using historical data of every international rugby match played by between the the historically best 10 international men's rugby teams in the world. The fixtures for the 2023 World Cup has already been released, with it consisting of group stages and knockout matches. Using the past match results from previous years, I will predict who will win every world cup game between the top 10 teams in the world, including the Rugby World Cup Final.

In order to conduct my analysis, I need to import the data set from excel format. This data set includes all matches which have been played since 1984, 3 years before the start of the first Rugby World Cup. 

```{r}
library(readxl)
df <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\Data\\Rugby_matches_data_1984-2023.xlsx")
```

I am going to do is generate 4 new columns, in order to identify the winner of each game, the points difference of each game and the winner of the World Cup. First I create a function to generate the points difference between the home_team and away_team.

```{r}
# Points difference
library(tidyverse)

df <- df %>% 
  mutate(points_diff = subtract(., "home_score", "away_score"))
```

Next is a variable for the winner and loser of the game.

```{r}
#Winner of game 
df <- df %>% 
  mutate(Winner = ifelse(points_diff > 0, home_team, ifelse(points_diff < 0, away_team, ".")),
         Loser = ifelse(points_diff < 0, home_team, ifelse(points_diff > 0, away_team, ".")))
```

Then a variable which indicates the winner of the World Cup

```{r}
# Winner of the World Cup
# Create a new column WC_winner

df <- df %>%
  mutate(WC_winner = NA) %>%
  {
    for (i in 1:(nrow(.) - 1)) {
      current_row <- .[i, ]
      next_row <- .[i + 1, ]
      
      if (current_row$world_cup & !next_row$world_cup) {
        .$WC_winner[i] <- current_row$Winner
      }
    }
    .
  }

```

I can now see the winners of each world cup up to date

```{r}
WC_Winners <- df %>%
  filter(!is.na(WC_winner)) %>%
  select(competition, WC_winner) %>%
  tibble()


# Print the summary
WC_Winners
```

Ok now I want to see what the win-loss percentage was for every world cup winning team in the 4 years leading up to their respective world cup victory. In order to do this I will look at the number of wins over the combined number of wins and losses over each 4 year period preceding the beginning of the world cup. First I'm going to create a 2 columns which indicate the year of each match as well as the world cup cycle of each non_world cup falls under.

```{r}
library(lubridate)

df <- df %>%
  mutate(year = year(date))

df <- df %>%
  mutate(WC_cycle = case_when(
    year <= 1987 & !world_cup ~ 1987,
    year > 1987 & year <= 1991 & !world_cup ~ 1991,
    year > 1991 & year <= 1995 & !world_cup ~ 1995,
    year > 1995 & year <= 1999 & !world_cup ~ 1999,
    year > 1999 & year <= 2003 & !world_cup ~ 2003,
    year > 2003 & year <= 2007 & !world_cup ~ 2007,
    year > 2007 & year <= 2011 & !world_cup ~ 2011,
    year > 2011 & year <= 2015 & !world_cup ~ 2015,
    year > 2015 & year <= 2019 & !world_cup ~ 2019,
    year > 2019 & year <= 2023 & !world_cup ~ 2023,
    TRUE ~ NA_integer_
  )) %>%
  mutate(WC_cycle = ifelse(is.na(WC_cycle), lag(WC_cycle), WC_cycle))

```

There is a bit of an issue in that some games were played after certain world cup in the same year and therefore get assigned to that year's world cup even though the games were played afterwards. However this shouldn't be an issue because we can group the data by both the rugby world cup cycle and the 

Ok now I want to calculate the win percentage for each world cup winning team in their respective world cup cycle. Lets first indicate the world cup winner for each world cup cycle vaue so that we can group it by world cup winner and world cup cycle.

```{r}
library(tidyr)

df <- df %>%
  mutate(WC_winner = ifelse(is.na(WC_winner), lag(WC_winner), WC_winner)) %>%
  fill(WC_winner, .direction = "up")
```

Ok so now to work out the win percentages of each WC winning tema against the top 10 teams in the world.


```{r}
win_loss <- win_percentage(df)
```

Ok so now it has given a table of the win percentages of each WC winning team against all the teams in our data set. However this data needs to be cleaned due to certain matches being played in the same year but being in the same year as a world cup but being played after the world cup, thereby falling under the next world cup cycle.

```{r}
win_loss <- win_loss %>% 
  combine_rows("Australia", "1987", "1991") %>% 
  combine_rows("Australia", "1995", "1999") %>%
  filter(!is.nan(win_percentage)) %>%
  filter(!is.na(WC_winner)) %>% 
  filter(!is.na(WC_cycle)) %>% 
  arrange(WC_cycle) %>% 
  tibble()

win_loss

Best_WC_team <- win_loss %>% 
  arrange(desc(win_percentage))

Best_WC_team
```

We can therefore see the respective win percentages of all world cup winning teams against the over top 10 teams in the world in the 4 year cycle preceding each World Cup. Based on this information it can be seen that the New Zealand team which won the 2015 World Cup was had the best win percentage with an an 89% win record. The second best was the England team that won the 2003 Rugby World Cup with an 86% win record, followed by the 2011 World Cup winning New Zealand team, who had an 80% win record. The worst performing team was the South African 1995 World Cup winning team who only managed to win 41% of their matched against top 10 opposition in the 4 years preceding their world cup campaign.

```{r}
win_percent_bar <- win_loss_bar(win_loss)
win_percent_bar
```

Next I want to include the World rankings of each team which have been collected since the conclusion of the 2003 Rugby World Cup. I need to web scrape this information.


```{r}
#Scraping the data
library(rvest)
url <- "https://commons.wikimedia.org/wiki/Data:Men%27s_World_Rugby_rankings.tab"
page <- read_html(url)
table_data <- page %>% html_table(fill = TRUE)
```

Now I turn that list which I scraped into a data frame and clean the data frame to only include the teams from the original data set.

```{r}
rankings <- generate_rankings(table_data)
```

Next I need to change the date variables from characters to dates in order to merge the ranking data frame with the main data frame (df).

```{r}
df$date <- as.Date(df$date, format = "%Y-%m-%d")
rankings$date <- as.Date(rankings$date, format = "%Y-%m-%d")
```

Ok so we have the rankings for all the top 10 teams since after the 2003 Rugby World Cup. Let's plot these ranking over time to see how each teams world ranking have changed. 

```{r}
all_rankings <- plot_rankings(rankings)
all_rankings
```

Let's decrease the number of teams in each graph so that it is slightly more interpretable. I'm first going to look at all the Southern Hemisphere teams (South Africa, New Zealand, Australia and Argentina). This graph will also show the ranking progression of the last 4 World Cup winning teams, two representing South Africa (2007 and 2019) and two representing New Zealand (2011 and 2015). In order to do this I am first going to split the rankings data set into a South And North data set.

```{r}
south <- rankings %>%
  select(date, South_Africa, New_Zealand, Australia, Argentina)

north <- rankings %>%
  select(-South_Africa, -New_Zealand, -Australia, -Argentina)

```


```{r}
# Plot the rankings of the Southern hemisphere
south_rankings <- plot_rankings(south)
south_rankings

# Now for the Northern Hemisphere
north_rankings <- plot_rankings(north)
north_rankings
```

So as can ben seen the Southern hemisphere teams have dominated the rankings historically, with New Zealnad in particular holding the number 1 spot for a long time. Let's see how the ranking have been in the last World Cup cycle.

```{r}
WC_cycle_23 <- rankings %>% 
  filter(date >= "2019-11-11")

rankings_23 <- plot_rankings(WC_cycle_23)
rankings_23
```

So as cna be seen, in this world cup cycle South Africa have be the top team for most of the time, however Ireland has held the number 1 rank for the last year. 

The rankings stand as such as of the 12 of June 2023.

```{r}
June_12_rankings <- WC_cycle_23 %>%
  filter(date == "2023-06-12") %>%
  t() %>%
  as.data.frame() %>%  
  slice(-1) %>%  
  setNames(c("Ranking")) %>%
  mutate(Ranking = as.numeric(Ranking)) %>%
  arrange(Ranking) %>% 
  rownames_to_column(var = "Team") %>%
  mutate(Team = replace(Team, Team == "New_Zealand", "New Zealand"),
         Team = replace(Team, Team == "South_Africa", "South Africa"))

June_12_rankings
```

So as can be seen the rankings show Ireland to be ranked number 1 on the most recent available rankings.

Next I want to look at the win percentage of each team against all other teams in the 4 year cycle before the world cup started. I also want to look at the win percentages between two teams for each respective match up between the teams. I will then import these results into a data set showing all matches which have been played at previous World Cups, what the result was and what was the total win percentage for the teams in that game, as well as their win percentage aginst each other.

```{r}
WC_matches <- WC_games(df)
WC_matches <- WC_matches %>%
  mutate(
    Winner = ifelse(points_diff > 0, home_team, away_team),
    Loser = ifelse(points_diff < 0, home_team, away_team)
  )
```

Ok so there have been 132 matches played between these teams at World Cups. As an input to my model I need to calculate the win percentage of each team against these other teams in the 4 year cycle preceding this particular world cup.

```{r}
win_percent_df <- bind_rows(
  win_percentages_SA %>% mutate(team = "South Africa"),
  win_percentages_NZ %>% mutate(team = "New Zealand"),
  win_percentages_AUS %>% mutate(team = "Australia"),
  win_percentages_ARG %>% mutate(team = "Argentina"),
  win_percentages_IRE %>% mutate(team = "Ireland"),
  win_percentages_ITA %>% mutate(team = "Italy"),
  win_percentages_FRA %>% mutate(team = "France"),
  win_percentages_SCO %>% mutate(team = "Scotland"),
  win_percentages_ENG %>% mutate(team = "England"),
  win_percentages_WAL %>% mutate(team = "Wales")
)
```

Ok now I need to import the winning percentages into the WC_matches data set so that I can show the win percentages of each team as an input into each game they played.

```{r}
WC_matches <- left_join(WC_matches, win_percent_df, by = c("year" = "WC_cycle", "home_team" = "team")) %>%
  mutate(HT_win_percent = win_percentage) %>%
  select(-win_percentage) %>%
  left_join(win_percent_df, by = c("year" = "WC_cycle", "away_team" = "team")) %>%
  mutate(AT_win_percent = win_percentage) %>%
  select(-win_percentage)


  
```

So now we've edited the WC_matches data set which shows the win percentages for each game, I want to include the rankings of each team from before each world cup began for the last 4 world cups, seeing as these are the only world cups where the rankings existed.


```{r}
before_WC_rank <- rankings %>%
  filter(date == "2007-09-03" | date == "2011-08-29" | date == "2015-09-07" | date == "2019-09-09") %>%
  t() %>%
  as.data.frame() %>%
  setNames(.[1, ]) %>%
  slice(-1) %>%
  rownames_to_column("Date") %>% 
  rename("2007" = "2007-09-03", "2011" = "2011-08-29", "2015" = "2015-09-07", "2019" = "2019-09-09") %>% 
  mutate(across(everything(), ~ ifelse(. == "New_Zealand", "New Zealand", .))) %>%
  mutate(across(everything(), ~ ifelse(. == "South_Africa", "South Africa", .)))
```

Ok now I have each teams ranking before the start of each world cup, now to combine this with the WC_matches data set to show the ranking of each world cup winning team and their opposition for before each world cup.

```{r}
WC_matches <- WC_matches %>%
  left_join(before_WC_rank, by = c("home_team" = "Date")) %>%
  select(-starts_with("Date")) %>%
  rename(HT_rank_2007 = starts_with("2007")) %>%
  left_join(before_WC_rank, by = c("away_team" = "Date")) %>%
  select(-starts_with("Date")) %>%
  rename(AT_rank_2007 = starts_with("2007"))
```


```{r}
WC_matches <- WC_matches %>%
  mutate(HT_rank_combined = case_when(
    year == "2007" ~ `HT_rank_2007`,
    year == "2011" ~ `2011.x`,
    year == "2015" ~ `2015.x`,
    year == "2019" ~ `2019.x`
  ),
  AT_rank_combined = case_when(
    year == "2007" ~ `AT_rank_2007`,
    year == "2011" ~ `2011.y`,
    year == "2015" ~ `2015.y`,
    year == "2019" ~ `2019.y`
  )) %>% 
  select( "year", "home_team",  "away_team", "HT_win_percent", "AT_win_percent", "points_diff", "Winner", "Loser", "HT_rank_combined","AT_rank_combined")
```

Ok now the onlly thing remaining is to indicate is the game was played at a neutral venue or not, this will only be the case if a particular team hosted the world cup and played. 

```{r}
WC_matches <- WC_matches %>%
  group_by(year, home_team) %>%
  mutate(neutral = ifelse(
    (year == 1987 & home_team == "New Zealand") |
    (year == 1991 & home_team == "England") |
    (year == 1995 & home_team == "South Africa") |
    (year == 1999 & home_team == "Wales") |
    (year == 2003 & home_team == "Australia") |
    (year == 2007 & home_team == "France") |
    (year == 2011 & home_team == "New Zealand") |
    (year == 2015 & home_team == "England"),
    FALSE,
    TRUE
  )) %>%
  ungroup()
```

Now I know that previous world cup wins has an effect on teams winning considering many teams have one multiple and there are so few teams to have won. Therefore I am going to include a variable which indicates how many world cups each teams has won before that particular world cup.

```{r}
WC_titles <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\data\\WC_titles.xlsx")

WC_titles <- WC_titles %>%
  pivot_longer(cols = -1, names_to = "column_name", values_to = "value") %>%
  select(-column_name) %>%
  mutate(
    Team = case_when(
      row_number() %% 4 == 1 ~ "New Zealand",
      row_number() %% 4 == 2 ~ "Australia",
      row_number() %% 4 == 3 ~ "South Africa",
      row_number() %% 4 == 0 ~ "England",
      TRUE ~ ""
    )
  )

WC_matches <- WC_matches %>%
  left_join(WC_titles, by = c("year" = "Date", "home_team" = "Team")) %>%
  mutate(HT_titles = ifelse(!is.na(value), value, 0)) %>%
  select(-value) %>%
  left_join(WC_titles, by = c("year" = "Date", "away_team" = "Team")) %>%
  mutate(AT_titles = ifelse(!is.na(value), value, 0)) %>%
  select(-value)

WC_matches <- WC_matches %>% 
  rename(HT_rank = HT_rank_combined,
         AT_rank = AT_rank_combined) %>% 
  mutate(HT_rank = ifelse(is.na(HT_rank), 15, HT_rank)) %>%
  mutate(AT_rank = ifelse(is.na(AT_rank), 15, AT_rank)) %>% 
  select(-Winner, -Loser)
```

Now the learning data set is ready. In order to include each team's ranking as a variable which determines the outcome I needed to replace all the NA's in the years before there were rankings with the value 15, as this is larger than all other ranking values. 

Now I need to import the data set for the 2023 Rugby World Cup fixtures. 

```{r}
RWC_23 <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\data\\RWC_2023_fixtures.xlsx")
```

I can see that I have 15 games which need to be predicted in order to determine who will win the 2023 Rugby World Cup.

So firstly I need to put in the necessary information in order to predict who will win each game. First it's about working out the win percentages of each team against all the teams in the data set over the last 4 years. I can use the win_percentgae data frame to iimport the relevant data.


```{r}
pool_RWC_23 <- process_RWC_data(RWC_23) %>% 
  slice(1:8)
```


Now both the training and testing data sets have been set up meaning I can perform a random forest to determine who is going to win the world cup.

```{r}
library("ranger")

rf1 <- ranger(
  points_diff ~ ., 
  data = WC_matches,
  mtry = floor(10 / 3),
  seed = 123
)

(default_rmse <- sqrt(rf1$prediction.error))
```

```{r}
# create hyperparameter grid
hyper_grid <- expand.grid(
  mtry = floor(10 * c(.1, .15, .25, .333, .4)),
  min.node.size = c(1, 3, 5, 10), 
  replace = c(TRUE, FALSE),                               
  sample.fraction = c(.5, .63, .8),                       
  rmse = NA                                               
)

# execute full cartesian grid search
for(i in seq_len(nrow(hyper_grid))) {
  # fit model for ith hyperparameter combination
  fit <- ranger(
    formula         = points_diff ~ ., 
    data            = WC_matches, 
    num.trees       = 10 * 10,
    mtry            = hyper_grid$mtry[i],
    min.node.size   = hyper_grid$min.node.size[i],
    replace         = hyper_grid$replace[i],
    sample.fraction = hyper_grid$sample.fraction[i],
    verbose         = FALSE,
    seed            = 123,
  )
  # export OOB error 
  hyper_grid$rmse[i] <- sqrt(fit$prediction.error)
}

# assess top 10 models
hyper_grid %>%
  arrange(rmse) %>%
  mutate(perc_gain = (default_rmse - rmse) / default_rmse * 100) %>%
  head(10)
```


```{r}
rf2 <- ranger(
  points_diff ~ ., 
  data = WC_matches,
  mtry = 4,
  min.node.size = 10,
  replace = TRUE,
  sample.fraction = 0.50,
  seed = 123
)
```

```{r}
predictions_rf2 <- predict(rf2, data = pool_RWC_23)$predictions

print(predictions_rf2)
```

Results:
Ok so now editing the relevant excel sheet to include the quarter finalists.

```{r}
QF_RWC_23 <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\data\\RWC_2023_fixtures_QF.xlsx")
  
QF_RWC_23 <- process_RWC_data(QF_RWC_23) %>% 
  slice(1:12)
```



```{r}
predictions_rf2_QF <- predict(rf2, data = QF_RWC_23)$predictions

print(predictions_rf2_QF)
```

```{r}
SF_RWC_23 <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\data\\RWC_2023_fixtures_SF.xlsx")
  
SF_RWC_23 <- process_RWC_data(SF_RWC_23) %>% 
  slice(1:14)
```



```{r}
predictions_rf2_SF <- predict(rf2, data = SF_RWC_23)$predictions
print(predictions_rf2_SF)
```

```{r}
F_RWC_23 <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\data\\RWC_2023_fixtures_F.xlsx")
  
F_RWC_23 <- process_RWC_data(F_RWC_23) %>% 
  slice(1:15)
```

```{r}
predictions_rf2_F <- predict(rf2, data = F_RWC_23)$predictions
print(predictions_rf2_F)
```

Therefore France will win the 2023 Rugby World Cup.

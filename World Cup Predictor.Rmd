---
title: "2023 Rugby World Predictor"
author: "Peter Meihuizen"
date: "2023-06-23"
output: html_document
---
Introduction:

For this project I will attempt to predict the winner of the 2023 Rugby World Cup using historical data of every international rugby match played by between the the historically best 10 international men's rugby teams in the world. The fixtures for the 2023 World Cup has already been released, with it consisting of group stages and knockout matches. Using the past match results from previous years, I will predict who will win every world cup game between the top 10 teams in the world, including the Rugby World Cup Final.

In order to conduct my analysis, I need to import the data set from excel format. This data set includes all matches which have been played since 1984, 3 years before the start of the first Rugby World Cup. 

```{r}
library(readxl)
df <- read_excel("C:\\Users\\Peter Meihuizen\\Desktop\\Masters\\1st Semester\\Data Science\\World Cup Project\\Data\\Rugby_matches_data_1984-2023.xlsx")
```

I am going to do is generate 4 new columns, in order to identify the winner of each game, the points difference of each game and the winner of the World Cup. First I create a function to generate the points difference between the home_team and away_team.

```{r}
# Points difference
library(tidyverse)

df <- df %>% 
  mutate(points_diff = subtract(., "home_score", "away_score"))
```

Next is a variable for the winner and loser of the game.

```{r}
#Winner of game 
df <- df %>% 
  mutate(Winner = ifelse(points_diff > 0, home_team, ifelse(points_diff < 0, away_team, ".")),
         Loser = ifelse(points_diff < 0, home_team, ifelse(points_diff > 0, away_team, ".")))
```

Then a variable which indicates the winner of the World Cup

```{r}
# Winner of the World Cup
# Create a new column WC_winner

df <- df %>%
  mutate(WC_winner = NA) %>%
  {
    for (i in 1:(nrow(.) - 1)) {
      current_row <- .[i, ]
      next_row <- .[i + 1, ]
      
      if (current_row$world_cup & !next_row$world_cup) {
        .$WC_winner[i] <- current_row$Winner
      }
    }
    .
  }

```

I can now see the winners of each world cup up to date

```{r}
WC_Winners <- df %>%
  filter(!is.na(WC_winner)) %>%
  select(competition, WC_winner) %>%
  tibble()


# Print the summary
WC_Winners
```

Ok now I want to see what the win-loss percentage was for every world cup winning team in the 4 years leading up to their respective world cup victory. In order to do this I will look at the number of wins over the combined number of wins and losses over each 4 year period preceding the beginning of the world cup. First I'm going to create a 2 columns which indicate the year of each match as well as the world cup cycle of each non_world cup falls under.

```{r}
library(lubridate)

df <- df %>%
  mutate(year = year(date))

df <- df %>%
  mutate(WC_cycle = case_when(
    year <= 1987 & !world_cup ~ 1987,
    year > 1987 & year <= 1991 & !world_cup ~ 1991,
    year > 1991 & year <= 1995 & !world_cup ~ 1995,
    year > 1995 & year <= 1999 & !world_cup ~ 1999,
    year > 1999 & year <= 2003 & !world_cup ~ 2003,
    year > 2003 & year <= 2007 & !world_cup ~ 2007,
    year > 2007 & year <= 2011 & !world_cup ~ 2011,
    year > 2011 & year <= 2015 & !world_cup ~ 2015,
    year > 2015 & year <= 2019 & !world_cup ~ 2019,
    year > 2019 & year <= 2023 & !world_cup ~ 2023,
    TRUE ~ NA_integer_
  )) %>%
  mutate(WC_cycle = ifelse(is.na(WC_cycle), lag(WC_cycle), WC_cycle))

```

There is a bit of an issue in that some games were played after certain world cup in the same year and therefore get assigned to that year's world cup even though the games were played afterwards. However this shouldn't be an issue because we can group the data by both the rugby world cup cycle and the 

Ok now I want to calculate the win percentage for each world cup winning team in their respective world cup cycle. Lets first indicate the world cup winner for each world cup cycle vaue so that we can group it by world cup winner and world cup cycle.

```{r}
library(tidyr)

df <- df %>%
  mutate(WC_winner = ifelse(is.na(WC_winner), lag(WC_winner), WC_winner)) %>%
  fill(WC_winner, .direction = "up")
```

Ok so now to work out the win percentages of each WC winning tema against the top 10 teams in the world.


```{r}
win_loss <- win_percentage(df)
```

Ok so now it has given a table of the win percentages of each WC winning team against all the teams in our data set. However this data needs to be cleaned due to certain matches being played in the same year but being in the same year as a world cup but being played after the world cup, thereby falling under the next world cup cycle.

```{r}
win_loss <- win_loss %>% 
  combine_rows("Australia", "1987", "1991") %>% 
  combine_rows("Australia", "1995", "1999") %>%
  filter(!is.nan(win_percentage)) %>%
  filter(!is.na(WC_winner)) %>% 
  filter(!is.na(WC_cycle)) %>% 
  arrange(WC_cycle) %>% 
  tibble()

win_loss

Best_WC_team <- win_loss %>% 
  arrange(desc(win_percentage))

Best_WC_team
  
```

We can therefore see the respective win percentages of all world cup winning teams against the over top 10 teams in the world in the 4 year cycle preceding each World Cup. Based on this information it can be seen that the New Zealand team which won the 2015 World Cup was had the best win percentage with an an 89% win record. The second best was the England team that won the 2003 Rugby World Cup with an 86% win record, followed by the 2011 World Cup winning New Zealand team, who had an 80% win record. The worst performing team was the South African 1995 World Cup winning team who only managed to win 41% of their matched against top 10 opposition in the 4 years preceding their world cup campaign.

```{r}
win_percent_bar <- win_loss_bar(win_loss)
win_percent_bar
```

Next I want to include the World rankings of each team which have been collected since the conclusion of the 2003 Rugby World Cup. I need to web scrape this information.


```{r}
#Scraping the data
library(rvest)
url <- "https://commons.wikimedia.org/wiki/Data:Men%27s_World_Rugby_rankings.tab"
page <- read_html(url)
table_data <- page %>% html_table(fill = TRUE)
```

Now I turn that list which I scraped into a data frame and clean the data frame to only include the teams from the original data set.

```{r}
rankings <- generate_rankings(table_data)
```

Next I need to change the date variables from characters to dates in order to merge the ranking data frame with the main data frame (df).

```{r}
df$date <- as.Date(df$date, format = "%Y-%m-%d")
rankings$date <- as.Date(rankings$date, format = "%Y-%m-%d")
```

Ok so we have the rankings for the last 4 World Cup winning teams, South Africa (2007 and 2019) and New Zealand (2011 and 2015). Let's see how their rankings have progressed for the last 20 years to see how they were ranked in the lead up to their respective world cup wins.

```{r}
# Example usage
teams <- c("South Africa", "New Zealand")
colors <- c("green", "black")

# Plot the rankings for the selected teams
SA_NZ <- plot_rankings(rankings, teams = teams, colors = colors)

SA_NZ

```




The rankings stand as such as of the 12 of June 2023.

```{r}
library(tibble)

June_12_2023_rankings <- rankings[rankings$date == "2023-06-12", ]

# Remove the "date" column
June_12_2023_rankings <- June_12_2023_rankings[, -1]

# Convert the row into a vector
values <- (unlist(June_12_2023_rankings))

# Sort the values in increasing order
sorted_values <- sort(values, decreasing = FALSE)

# Create a list of values and column names
result_tibble <- tibble(Column_names = column_name$sorted_values, Value = as.character(sorted_values))

# Print the result list
print(result_tibble)

```


Then I need to merged the data sets to put the rankings of each team into the main data frame.

```{r}
June_12_2023_rankings <- rankings[rankings$date == "2023-06-12", ]

# Remove the "date" column
selected_row <- selected_row[, -1]

# Convert the row into a vector
values <- as.numeric(unlist(selected_row))

# Sort the values in descending order
sorted_values <- sort(values, decreasing = TRUE)

# Sort the column names accordingly
sorted_names <- names(sorted_values)

# Plot the values and column names in descending order
barplot(sorted_values, names.arg = sorted_names, horiz = TRUE, las = 1, main = "Rankings on 2023-06-12")

```

